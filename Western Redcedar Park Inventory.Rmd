---
title: "Western Redcedar Point Defiance Data Analysis"
output: html_document
date: "2025-08-02"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# **Packages/Libraries Used**

Load Tidyverse.
```{r}
library(tidyverse)
```

Load Stringdist.
```{r}
library(stringdist)
```

Load Tidytext.
```{r}
library(tidytext)
```

Load Fuzzyjoin.
```{r}
library(fuzzyjoin)
```

Load Permute (required package for vegan).
```{r}
library(permute)
```

Load Vegan.
```{r}
library(vegan)
```

Load Indicspecies.
```{r}
library(indicspecies)
```

# **Data Wrangling**

Import observations.
```{r}
i.nat.all <- read.csv("observations-601233.csv")
```

#### **NMDS Analysis Prep**

For the "Most Prevalent Understory Species" field our NMDS prep will consist of creating a list of species for filtering, setting everything to lowercase and removing common delimiters, creating tokens, running a fuzzymatch based off of the tokens and seeing what matches up with our species filter, and creating a species matrix.

Vector to filter species prep for NMDS.
```{r}
SpeciesList <- c("huckleberry", "oregon grape", "himalayan blackberry", "trailing blackberry", "fern", "sword fern", "bracken fern", "salal", "salmonberry", "holly", "western starflower", "nettle", "mountain sweet cicely", "ocean spray", "pacific sanicle", "american trailplant", "horse chestnut", "cedar", "evergreen huckleberry", "wax myrtle", "stinking iris", "cotoneaster", "horsetail", "cherry laurel", "mountain huckleberry", "thimble berry", "ivy")
```

Lowercase everything, remove extra spaces, and common delimiters.
```{r}
Token.Prep <- i.nat.all %>%
  mutate(field.most.prevalent.understory.species = str_to_lower(field.most.prevalent.understory.species),
         field.most.prevalent.understory.species = str_replace_all(field.most.prevalent.understory.species, "(/| and |&|\\+),", " "),
         field.most.prevalent.understory.species = str_replace_all(field.most.prevalent.understory.species, ",", " "),
         field.most.prevalent.understory.species = str_squish(field.most.prevalent.understory.species))
```

Replace all unfilled observation fields with "none".
```{r}
Token.Prep <- Token.Prep %>%
  mutate(field.most.prevalent.understory.species = ifelse(field.most.prevalent.understory.species == "", "none", field.most.prevalent.understory.species))
```

Tokenize n = 1.
```{r}
Token.Prep.1gram <- Token.Prep %>%
  select(id, field.most.prevalent.understory.species) %>%
  unnest_tokens(output = "ngram", input = field.most.prevalent.understory.species, token = "ngrams", n = 1)
```

Tokenize n = 2.
```{r}
Token.Prep.2gram <- Token.Prep %>%
  select(id, field.most.prevalent.understory.species) %>%
  unnest_tokens(output = "ngram", input = field.most.prevalent.understory.species, token = "ngrams", n = 2)
```

Tokenize n = 3.
```{r}
Token.Prep.3gram <- Token.Prep %>%
  select(id, field.most.prevalent.understory.species) %>%
  unnest_tokens(output = "ngram", input = field.most.prevalent.understory.species, token = "ngrams", n = 3)
```

Merge all 3 token dataframes.
```{r}
Token.Prep.All <- bind_rows(Token.Prep.1gram, Token.Prep.2gram, Token.Prep.3gram) %>%
  distinct()
```

Fuzzy match.
```{r}
FuzzyMatchedSpeciesList <- stringdist_left_join(Token.Prep.All, 
  data.frame(ngram = SpeciesList), 
  method = "jw",
  max_dist = 0.15,
  distance_col = "dist")
```

Filter fuzzy match and remove NA.
```{r}
CleanedFuzzyMatch <- FuzzyMatchedSpeciesList %>%
  filter(!is.na(ngram.y))
```

Create species matrix.
```{r}
SpeciesMatrix <- CleanedFuzzyMatch %>%
  distinct(id, ngram.y) %>%
  mutate(presence = 1) %>%
  pivot_wider(names_from = ngram.y, values_from = presence, values_fill = 0)
```

Create new data frame of trees with tree canopy health data combined with Species Matrix.
```{r}
TreeCanopyHealthData <- i.nat.all[,c("id","field.tree.health.condition")]
  
CombinedMatrix <- left_join(TreeCanopyHealthData, SpeciesMatrix, by = "id")
```

We still have NA left over from observations that did not have any under story species observed, for our NMDS they need to be removed.
```{r}
CombinedMatrix2 <- na.omit(CombinedMatrix)
```

Then we remove all the observations with (No selection) for tree canopy health.
```{r}
CombinedCleanedMatrix <- CombinedMatrix2 %>% filter(field.tree.health.condition != "No selection")
```

Remove Tree Health Condition Column for NMDS and remove tree ids column.
```{r}
UnderstorySpeciesValuesMatrix <- CombinedCleanedMatrix %>%
  select(-id, -field.tree.health.condition)
```

#### **NMDS Analysis**
Run NMDS.
```{r}
NMDSRun1 <- metaMDS(UnderstorySpeciesValuesMatrix,
                    distance = "jaccard",
                    binary = TRUE,
                    k = 2,
                    trymax = 10)
```

Checking results.
```{r}
print(NMDSRun1)
```

Checking orientation distance.
```{r}
stressplot(NMDSRun1)
```

Plotting graph.
```{r}
plot(NMDSRun1, display = "sites", type = "t")
```

Extract NMDSRun1 Scores.
```{r}
NMDSRun1Scores <- scores(NMDSRun1, display = "sites")
```

#### **Visualizing NMDS Data**

Extract Tree Canopy Health Scores.
```{r}
TreeCanopyHealthScoringPrep <- CombinedCleanedMatrix[,c("field.tree.health.condition")]
```

Visualizing data with color scores.
```{r}
ggplot(NMDSRun1Scores, aes(x = NMDS1, y = NMDS2, color = TreeCanopyHealthScoringPrep)) +
  geom_point(size = 3) +
  scale_color_manual(values = c("Good" = "forestgreen", "Fair" = "yellow", "Poor" = "orange", "Dead" = "red")) +
  theme_minimal() +
  stat_ellipse(type = "norm", level = 0.95) +
  labs(title = "NMDS with Tree Health Scores", color = "Tree Health") +
  coord_cartesian(xlim = c(-5, 5), ylim = c(-1, 1))
```

As of the day of writing this after running the final NMDS analysis it seems we just don't have a large enough sample size with enough dead trees to confirm if there is any relationship between observed understory plants and overall tree health. As this project continues to grow with more data collected and more parks assessed future assessments on the data may yield more interesting results. 

Something that may want to be considered is re framing the observation field of "Most prevalent Under story species" instead into "Under story Species Found" as the volunteers have been logging every visible under story plant species found within the under story of each tree.

#### **Indicator Species Analysis**

Indicator Species analysis to check if there is any species that are potential "indicators" of tree health.
```{r}
IndicatorSpeciesAnalysis <- multipatt(UnderstorySpeciesValuesMatrix, TreeCanopyHealthScoringPrep, func = "IndVal.g", duleg = TRUE, control = how(nperm=999))
summary(IndicatorSpeciesAnalysis)
```

No species were found to be indicators.

#### **Sorting Tree Condition**

Separating column for Tree Conditions.
```{r}
good_count <- TreeCanopyHealthData %>%
  summarise(good_count = sum(field.tree.health.condition == "Good")) %>%
  pull(good_count)
fair_count <- TreeCanopyHealthData %>%
  summarise(fair_count = sum(field.tree.health.condition == "Fair")) %>%
  pull(fair_count)
poor_count <- TreeCanopyHealthData %>%
  summarise(poor_count = sum(field.tree.health.condition == "Poor")) %>%
  pull(poor_count)
dead_count <- TreeCanopyHealthData %>%
  summarise(dead_count = sum(field.tree.health.condition == "Dead")) %>%
  pull(dead_count)
```

Create list of Tree Conditions.
```{r}
tcs=c("602", "128", "28", "1")
```

Create from list of tree conditions data frame on tree condition.
```{r}
Tree.Condition.Summary <- data.frame(
  category=c("Good","Fair","Poor", "Dead") , 
  value=as.numeric(tcs)
)
```

Bar chart.
```{r}
ggplot(Tree.Condition.Summary, aes(x=reorder(category, -value) , y=value)) +
  geom_bar(stat = "identity") +
  labs(x = "Tree Condition", y = "Tree Count", title = "Tree Condition of Western Red Cedar Found at Point Defiance 2025")
```

Creating CSVs for tree conditions for GIS prep.
```{r}
TreeConditionGIS <- i.nat.all[c(3,4,10)]

GisPrepTreeHealthConditionGood <- TreeConditionGIS %>%
  filter(field.tree.health.condition == "Good") %>%
  select(`field.tree.health.condition`, latitude, longitude)
  write_csv(GisPrepTreeHealthConditionGood, "TreeHealthConditionGood.csv")
  
GisPrepTreeHealthConditionFair <- TreeConditionGIS %>%
  filter(field.tree.health.condition == "Fair") %>%
  select(`field.tree.health.condition`, latitude, longitude)
  write_csv(GisPrepTreeHealthConditionFair, "TreeHealthConditionFair.csv")
  
GisPrepTreeHealthConditionPoor <- TreeConditionGIS %>%
  filter(field.tree.health.condition == "Poor") %>%
  select(`field.tree.health.condition`, latitude, longitude)
  write_csv(GisPrepTreeHealthConditionPoor, "TreeHealthConditionPoor.csv")
  
GisPrepTreeHealthConditionDead <- TreeConditionGIS %>%
  filter(field.tree.health.condition == "Dead") %>%
  select(`field.tree.health.condition`, latitude, longitude)
  write_csv(GisPrepTreeHealthConditionDead, "TreeHealthConditionDead.csv")
```


#### **Sorting DBH Sizes into Buckets**

For tree size a histogram with bucket size **5 inch** for now should suffice for our purposes.

Separate DBH column into its own data frame.
```{r}
DBH.Inch <- i.nat.all[c(12)]
```

Create histogram. (Bin = 5 Inches starting from 0)
```{r}
ggplot(DBH.Inch, aes(x = field.tree.diameter)) + 
  geom_histogram(binwidth = 5, boundary = 0, fill = "springgreen4", color = "black") + 
  stat_bin(binwidth = 5, boundary = 0, geom = "text", aes(label = after_stat(count), vjust = -0.5)) + 
  labs(x = "DBH", y = "Count", title = "Western Red Cedar Tree Sizes Found at Point Defiance 2025")
```

The 27 entries removed were entries without DBH's entered.

#### **ArcGIS Species Mapping GIS Prep**

In order to create the species maps I will need to attach GPS coordinates from the i.nat.all dataframe with the SpeciesMatrix dataframe and then filter for presence from the 1s and 0s from each column and separate each of those into CSV files for ArcGIS.

Creating dataframe with just longitude, latitude and id.
```{r}
GPSCoords <- i.nat.all[c(1,3,4)]
```

Combining based off of ID columns in GPSCoords with SpeciesMatrix.
```{r}
GPSCoordPrep <- left_join(SpeciesMatrix,GPSCoords, by = "id")
```

Filtering rows based on presence of species X and turning created dataframes into CSVs.

Salal.
```{r}
GisPrepSalal <- GPSCoordPrep %>%
  filter(`salal` == 1) %>%
  select(`salal`, latitude, longitude)
  write_csv(GisPrepSalal, "Salal.csv")
```

Wax Myrtle.
```{r}
GisPrepWaxMyrtle <- GPSCoordPrep %>%
  filter(`wax myrtle` == 1) %>%
  select(`wax myrtle`, latitude, longitude)
  write_csv(GisPrepWaxMyrtle, "WaxMyrtle.csv")
```

Fern.
```{r}
GisPrepFern <- GPSCoordPrep %>%
  filter(`fern` == 1) %>%
  select(`fern`, latitude, longitude)
  write_csv(GisPrepFern, "Fern.csv")
```

Ivy.
```{r}
GisPrepIvy <- GPSCoordPrep %>%
  filter(`ivy` == 1) %>%
  select(`ivy`, latitude, longitude)
  write_csv(GisPrepIvy, "Ivy.csv")
```

Stinking Iris.
```{r}
GisPrepStinkingIris <- GPSCoordPrep %>%
  filter(`stinking iris` == 1) %>%
  select(`stinking iris`, latitude, longitude)
  write_csv(GisPrepStinkingIris, "StinkingIris.csv")
```

Huckleberry.
```{r}
GisPrepHuckleberry <- GPSCoordPrep %>%
  filter(`huckleberry` == 1) %>%
  select(`huckleberry`, latitude, longitude)
  write_csv(GisPrepHuckleberry, "Huckleberry.csv")
```

Cedar.
```{r}
GisPrepCedar <- GPSCoordPrep %>%
  filter(`cedar` == 1) %>%
  select(`cedar`, latitude, longitude)
  write_csv(GisPrepCedar, "Cedar.csv")
```

Holly.
```{r}
GisPrepHolly <- GPSCoordPrep %>%
  filter(`holly` == 1) %>%
  select(`holly`, latitude, longitude)
  write_csv(GisPrepHolly, "Holly.csv")
```

Sword Fern.
```{r}
GisPrepSwordFern <- GPSCoordPrep %>%
  filter(`sword fern` == 1) %>%
  select(`sword fern`, latitude, longitude)
  write_csv(GisPrepSwordFern, "SwordFern.csv")
```

Horsetail.
```{r}
GisPrepHorsetail <- GPSCoordPrep %>%
  filter(`horsetail` == 1) %>%
  select(`horsetail`, latitude, longitude)
  write_csv(GisPrepHorsetail, "Horsetail.csv")
```

Bracken Fern.
```{r}
GisPrepBrackenFern <- GPSCoordPrep %>%
  filter(`bracken fern` == 1) %>%
  select(`bracken fern`, latitude, longitude)
  write_csv(GisPrepBrackenFern, "BrackenFern.csv")
```

Cotoneaster.
```{r}
GisPrepCotoneaster <- GPSCoordPrep %>%
  filter(`cotoneaster` == 1) %>%
  select(`cotoneaster`, latitude, longitude)
  write_csv(GisPrepCotoneaster, "Cotoneaster.csv")
```

Nettle.
```{r}
GisPrepNettle <- GPSCoordPrep %>%
  filter(`nettle` == 1) %>%
  select(`nettle`, latitude, longitude)
  write_csv(GisPrepNettle, "Nettle.csv")
```

Salmonberry.
```{r}
GisPrepSalmonberry <- GPSCoordPrep %>%
  filter(`salmonberry` == 1) %>%
  select(`salmonberry`, latitude, longitude)
  write_csv(GisPrepSalmonberry, "Salmonberry.csv")
```

Cherry Laurel.
```{r}
GisPrepCherryLaurel <- GPSCoordPrep %>%
  filter(`cherry laurel` == 1) %>%
  select(`cherry laurel`, latitude, longitude)
  write_csv(GisPrepCherryLaurel, "CherryLaurel.csv")
```

Oregon Grape.
```{r}
GisPrepOregonGrape <- GPSCoordPrep %>%
  filter(`oregon grape` == 1) %>%
  select(`oregon grape`, latitude, longitude)
  write_csv(GisPrepOregonGrape, "OregonGrape.csv")
```

Trailing Blackberry.
```{r}
GisPrepTrailingBlackberry <- GPSCoordPrep %>%
  filter(`trailing blackberry` == 1) %>%
  select(`trailing blackberry`, latitude, longitude)
  write_csv(GisPrepTrailingBlackberry, "TrailingBlackberry.csv")
```

Ocean Spray.
```{r}
GisPrepOceanSpray <- GPSCoordPrep %>%
  filter(`ocean spray` == 1) %>%
  select(`ocean spray`, latitude, longitude)
  write_csv(GisPrepOceanSpray, "OceanSpray.csv")
```

Evergreen Huckleberry.
```{r}
GisPrepEvergreenHuckleberry <- GPSCoordPrep %>%
  filter(`evergreen huckleberry` == 1) %>%
  select(`evergreen huckleberry`, latitude, longitude)
write_csv(GisPrepEvergreenHuckleberry, "EvergreenHuckleberry.csv")
```

Western Starflower.
```{r}
GisPrepWesternStarflower <- GPSCoordPrep %>%
  filter(`western starflower` == 1) %>%
  select(`western starflower`, latitude, longitude)
write_csv(GisPrepWesternStarflower, "WesternStarflower.csv")
```

Himalayan Blackberry.
```{r}
GisPrepHimalayanBlackberry <- GPSCoordPrep %>%
  filter(`himalayan blackberry` == 1) %>%
  select(`himalayan blackberry`, latitude, longitude)
write_csv(GisPrepHimalayanBlackberry, "HimalayanBlackberry.csv")
```

Horse Chestnut.
```{r}
GisPrepHorseChestnut <- GPSCoordPrep %>%
  filter(`horse chestnut` == 1) %>%
  select(`horse chestnut`, latitude, longitude)
write_csv(GisPrepHorseChestnut, "HorseChestnut.csv")
```

Pacific Sanicle.
```{r}
GisPrepPacificSanicle <- GPSCoordPrep %>%
  filter(`pacific sanicle` == 1) %>%
  select(`pacific sanicle`, latitude, longitude)
write_csv(GisPrepPacificSanicle, "PacificSanicle.csv")
```

American Trailplant.
```{r}
GisPrepAmericanTrailplant <- GPSCoordPrep %>%
  filter(`american trailplant` == 1) %>%
  select(`american trailplant`, latitude, longitude)
write_csv(GisPrepAmericanTrailplant, "AmericanTrailplant.csv")
```

Mountain Sweet Cicely.
```{r}
GisPrepMountainSweetCicely <- GPSCoordPrep %>%
  filter(`mountain sweet cicely` == 1) %>%
  select(`mountain sweet cicely`, latitude, longitude)
write_csv(GisPrepMountainSweetCicely, "MountainSweetCicely.csv")
```

#### **Mapping understory diversity**

Another way to also visually represent the data is to look at the diversity of species at each location. We can do this by giving each GPS point a "score" corresponding to the # of understory species found and then marking/coloring them in ARCGis based on species diversity.


#### **Breaking up dates**

We can also create a timelapse of the map slowly filling with observations. Might underscore how much work went into gathering the data.








